// Dharma Realty - Complete Database Schema
// Prisma Schema for PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTHENTICATION ====================

model User {
  id                   String              @id @default(uuid())
  email                String              @unique
  passwordHash         String?
  firstName            String
  lastName             String
  phone                String?
  profilePhotoUrl      String?
  userType             UserType            @default(BUYER)
  dateOfBirth          DateTime?
  birthTime            String?             // For astrological calculations
  birthPlace           String?             // For astrological calculations
  kycVerified          Boolean             @default(false)
  kycDocuments         Json?
  walletAddress        String?             // Blockchain wallet
  preferredLanguage    String              @default("en")
  timezone             String?
  doshaType            DoshaType?          // Ayurvedic constitution
  lifePathNumber       Int?                // Numerology
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  lastLoginAt          DateTime?
  isActive             Boolean             @default(true)
  
  // Relations
  agent                Agent?
  savedSearches        SavedSearch[]
  favorites            Favorite[]
  leads                Lead[]              @relation("BuyerLeads")
  messages             Message[]           @relation("SentMessages")
  receivedMessages     Message[]           @relation("ReceivedMessages")
  reviews              Review[]            @relation("ReviewAuthor")
  propertyViews        PropertyView[]
  notifications        Notification[]
  karmicScores         KarmicScore[]       @relation("UserKarmic")
  referralsMade        Referral[]          @relation("Referrer")
  referralsReceived    Referral[]          @relation("Referred")
  daoVotes             DAOVote[]
  tokenBalance         TokenBalance?
  comparisons          PropertyComparison[]
  
  @@index([email])
  @@index([userType])
  @@index([walletAddress])
}

enum UserType {
  BUYER
  SELLER
  AGENT
  ADMIN
  INVESTOR
}

enum DoshaType {
  VATA
  PITTA
  KAPHA
  VATA_PITTA
  PITTA_KAPHA
  VATA_KAPHA
  TRIDOSHA
}

// ==================== AGENT ====================

model Agent {
  id                   String              @id @default(uuid())
  userId               String              @unique
  user                 User                @relation(fields: [userId], references: [id])
  licenseNumber        String
  licenseState         String
  licenseExpiry        DateTime
  brokerage            String?
  brokerageAddress     String?
  yearsExperience      Int
  specialties          String[]
  serviceAreas         String[]
  languages            String[]
  bio                  String?
  websiteUrl           String?
  linkedinUrl          String?
  rating               Float               @default(0)
  reviewCount          Int                 @default(0)
  subscriptionTier     SubscriptionTier    @default(FREE)
  subscriptionExpiry   DateTime?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  verified             Boolean             @default(false)
  verificationDate     DateTime?
  ethicsScore          Float               @default(100) // Dharmic ethics score
  responseTime         Int?                // Average response time in minutes
  closingRate          Float?              // Percentage of leads converted
  totalSalesVolume     Decimal             @default(0) @db.Decimal(15, 2)
  certificationsJson   Json?               // Vastu, Feng Shui certifications
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  
  // Relations
  properties           Property[]
  leads                Lead[]              @relation("AgentLeads")
  reviews              Review[]            @relation("AgentReviews")
  availability         AgentAvailability[]
  performanceMetrics   AgentPerformance[]
  
  @@index([licenseNumber])
  @@index([subscriptionTier])
  @@index([rating])
}

enum SubscriptionTier {
  FREE
  DHARMA        // $499/month
  KARMA         // $1,499/month
  ENLIGHTENED   // $4,999/month - Enterprise
}

model AgentAvailability {
  id          String    @id @default(uuid())
  agentId     String
  agent       Agent     @relation(fields: [agentId], references: [id])
  dayOfWeek   Int       // 0-6, Sunday-Saturday
  startTime   String    // HH:mm format
  endTime     String    // HH:mm format
  isAvailable Boolean   @default(true)
  
  @@unique([agentId, dayOfWeek, startTime])
}

model AgentPerformance {
  id              String    @id @default(uuid())
  agentId         String
  agent           Agent     @relation(fields: [agentId], references: [id])
  month           DateTime  @db.Date
  leadsReceived   Int       @default(0)
  leadsConverted  Int       @default(0)
  propertiesListed Int      @default(0)
  propertiesSold  Int       @default(0)
  totalVolume     Decimal   @default(0) @db.Decimal(15, 2)
  avgResponseTime Int?      // minutes
  avgRating       Float?
  
  @@unique([agentId, month])
}

// ==================== PROPERTY ====================

model Property {
  id                    String              @id @default(uuid())
  mlsId                 String?             @unique
  listingAgentId        String?
  listingAgent          Agent?              @relation(fields: [listingAgentId], references: [id])
  
  // Basic Info
  title                 String
  description           String              @db.Text
  propertyType          PropertyType
  listingType           ListingType
  status                PropertyStatus      @default(ACTIVE)
  
  // Location
  streetAddress         String
  unit                  String?
  city                  String
  state                 String
  zipCode               String
  country               String              @default("USA")
  latitude              Float
  longitude             Float
  neighborhoodId        String?
  neighborhood          Neighborhood?       @relation(fields: [neighborhoodId], references: [id])
  
  // Property Details
  price                 Decimal             @db.Decimal(15, 2)
  originalPrice         Decimal?            @db.Decimal(15, 2)
  pricePerSqft          Decimal?            @db.Decimal(10, 2)
  bedrooms              Int
  bathrooms             Float
  squareFeet            Int?
  lotSizeAcres          Float?
  yearBuilt             Int?
  stories               Int?
  parkingSpaces         Int?
  garageSpaces          Int?
  constructionDate      DateTime?           // For Kundali matching
  
  // Features
  features              String[]
  amenities             String[]
  appliances            String[]
  flooring              String[]
  heating               String[]
  cooling               String[]
  roofType              String?
  exteriorMaterial      String?
  foundationType        String?
  
  // Media
  photos                PropertyPhoto[]
  virtualTourUrl        String?
  videoUrl              String?
  floorPlanUrl          String?
  
  // Financial
  hoaFee                Decimal?            @db.Decimal(10, 2)
  hoaFrequency          String?             // monthly, quarterly, annual
  propertyTax           Decimal?            @db.Decimal(10, 2)
  taxYear               Int?
  estimatedMortgage     Decimal?            @db.Decimal(10, 2)
  
  // Dates
  listedDate            DateTime            @default(now())
  soldDate              DateTime?
  closingDate           DateTime?
  daysOnMarket          Int                 @default(0)
  
  // Stats
  viewCount             Int                 @default(0)
  favoriteCount         Int                 @default(0)
  inquiryCount          Int                 @default(0)
  
  // Blockchain
  blockchainTokenId     String?             @unique
  nftMinted             Boolean             @default(false)
  contractAddress       String?
  
  // Smart Home
  smartHomeScore        Int?                // 0-100
  smartHomeDevices      Json?
  
  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relations
  priceHistory          PriceHistory[]
  vastuAnalysis         VastuAnalysis?
  fengShuiAnalysis      FengShuiAnalysis?
  climateAnalysis       ClimateAnalysis?
  environmentalData     EnvironmentalData?
  blockchainHistory     BlockchainRecord[]
  iotSensors            IoTSensor[]
  leads                 Lead[]
  favorites             Favorite[]
  views                 PropertyView[]
  openHouses            OpenHouse[]
  inspections           Inspection[]
  documents             PropertyDocument[]
  comparisons           PropertyComparison[]
  fractionalShares      FractionalShare[]
  maintenanceRecords    MaintenanceRecord[]
  energyAnalysis        EnergyAnalysis?
  sacredGeometry        SacredGeometryAnalysis?
  landEnergy            LandEnergyAssessment?
  puranicAnalysis       PuranicAnalysis?
  ayurvedicAnalysis     AyurvedicAnalysis?
  
  @@index([city, state])
  @@index([price])
  @@index([propertyType])
  @@index([status])
  @@index([latitude, longitude])
  @@index([bedrooms, bathrooms])
}

enum PropertyType {
  HOUSE
  CONDO
  TOWNHOUSE
  APARTMENT
  LAND
  MULTI_FAMILY
  COMMERCIAL
  VILLA
  PENTHOUSE
  FARMHOUSE
  ASHRAM         // Spiritual retreat
  PLOT           // Land for development
}

enum ListingType {
  SALE
  RENT
  LEASE
  AUCTION
}

enum PropertyStatus {
  ACTIVE
  PENDING
  SOLD
  OFF_MARKET
  COMING_SOON
  WITHDRAWN
}

model PropertyPhoto {
  id          String    @id @default(uuid())
  propertyId  String
  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  url         String
  thumbnailUrl String?
  caption     String?
  roomType    String?
  orderIndex  Int       @default(0)
  isPrimary   Boolean   @default(false)
  aiVerified  Boolean   @default(false) // Deepfake detection passed
  createdAt   DateTime  @default(now())
  
  @@index([propertyId, orderIndex])
}

model PriceHistory {
  id            String    @id @default(uuid())
  propertyId    String
  property      Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  previousPrice Decimal   @db.Decimal(15, 2)
  newPrice      Decimal   @db.Decimal(15, 2)
  changeDate    DateTime  @default(now())
  changeReason  String?
  
  @@index([propertyId, changeDate])
}

// ==================== VASTU SHASTRA ====================

model VastuAnalysis {
  id                    String    @id @default(uuid())
  propertyId            String    @unique
  property              Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Overall Score
  overallScore          Int       // 0-100
  grade                 String    // A+, A, B+, B, C, D, F
  
  // Directional Analysis
  entranceDirection     String    // N, NE, E, SE, S, SW, W, NW
  entranceScore         Int
  plotOrientation       String
  plotScore             Int
  
  // Zone Scores (0-100)
  northEastScore        Int       // Ishaan - Water, Wealth
  eastScore             Int       // Indra - Sun, Health
  southEastScore        Int       // Agni - Fire, Kitchen
  southScore            Int       // Yama - Death, Avoid bedrooms
  southWestScore        Int       // Nairutya - Master bedroom
  westScore             Int       // Varuna - Water storage
  northWestScore        Int       // Vayu - Air, Guests
  northScore            Int       // Kubera - Wealth
  centerScore           Int       // Brahmasthan - Should be open
  
  // Room Placement Analysis
  kitchenPlacement      Json      // {correct: boolean, current: string, ideal: string}
  masterBedroomPlacement Json
  bathroomPlacement     Json
  poojaRoomPlacement    Json
  studyRoomPlacement    Json
  livingRoomPlacement   Json
  
  // Defects Found
  defects               Json[]    // Array of defect objects
  criticalDefects       Int       @default(0)
  moderateDefects       Int       @default(0)
  minorDefects          Int       @default(0)
  
  // Remedies
  remedies              Json[]    // Array of remedy objects with type, cost, effectiveness
  totalRemedyCost       Decimal?  @db.Decimal(10, 2)
  
  // Additional Analysis
  slopeAnalysis         Json?     // Land slope direction and impact
  waterSourceAnalysis   Json?     // Underground water, tanks, etc.
  staircaseAnalysis     Json?     // Direction, clockwise/anticlockwise
  beamAnalysis          Json?     // Overhead beams in sleeping areas
  
  // Certification
  certificateUrl        String?
  blockchainTxHash      String?
  
  analyzedAt            DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@index([overallScore])
}

// ==================== FENG SHUI ====================

model FengShuiAnalysis {
  id                    String    @id @default(uuid())
  propertyId            String    @unique
  property              Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  overallScore          Int       // 0-100
  
  // Bagua Map Analysis
  baguaAnalysis         Json      // 8 areas: wealth, fame, love, family, health, creativity, knowledge, career
  
  // Flying Stars
  flyingStarsChart      Json      // 9 palace grid with star numbers
  currentPeriod         Int       // Period 9 (2024-2043)
  mountainStar          Int
  waterStar             Int
  
  // Five Elements Balance
  woodElement           Int       // 0-100
  fireElement           Int
  earthElement          Int
  metalElement          Int
  waterElement          Int
  elementBalance        String    // Balanced, Wood-deficient, Fire-excess, etc.
  
  // Water Dragon Formula
  waterDragonScore      Int?
  waterFeatureRecommendation Json?
  
  // Chi Flow
  chiFlowScore          Int
  blockedAreas          String[]
  recommendations       Json[]
  
  analyzedAt            DateTime  @default(now())
}

// ==================== SACRED GEOMETRY ====================

model SacredGeometryAnalysis {
  id                    String    @id @default(uuid())
  propertyId            String    @unique
  property              Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  overallScore          Int       // 0-100
  
  // Golden Ratio Analysis
  goldenRatioScore      Int
  goldenRatioDetails    Json      // Room proportions, architectural elements
  
  // Fibonacci Presence
  fibonacciScore        Int
  fibonacciElements     Json[]
  
  // Mandala Alignment
  mandalaScore          Int
  centerPointEnergy     Int
  
  // Yantra Compatibility
  recommendedYantras    Json[]    // Sri Yantra, Kubera Yantra, etc.
  yantraPlacement       Json      // Where to place yantras
  
  // Platonic Solids
  geometricHarmony      Int
  
  analyzedAt            DateTime  @default(now())
}

// ==================== LAND ENERGY (BHUMI SHUDDHI) ====================

model LandEnergyAssessment {
  id                    String    @id @default(uuid())
  propertyId            String    @unique
  property              Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  overallScore          Int       // 0-100
  
  // Historical Analysis
  historicalUse         Json[]    // Past uses: temple, burial, hospital, etc.
  historicalScore       Int
  
  // Geological Features
  leyLineProximity      Float?    // Distance to nearest ley line in km
  energyVortex          Boolean   @default(false)
  geologicalFormations  Json?
  
  // Water Analysis
  waterTableDepth       Float?    // meters
  waterQuality          String?
  naturalSprings        Boolean   @default(false)
  
  // Soil Analysis
  soilComposition       Json?
  soilFertility         Int?      // 0-100
  contamination         Boolean   @default(false)
  contaminationType     String?
  
  // Tree Analysis
  ancientTrees          Int       @default(0)
  treeSpecies           String[]
  treeEnergyScore       Int?
  
  // Cosmic Alignment
  cardinalAlignment     Json?     // How well aligned with cardinal directions
  celestialEvents       Json?     // Sunrise/sunset alignment on solstices
  
  analyzedAt            DateTime  @default(now())
}

// ==================== PURANIC LAND ANALYSIS ====================

model PuranicAnalysis {
  id                    String    @id @default(uuid())
  analysis_id           String    @unique
  propertyId            String    @unique
  property              Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  classification        String    // Uttama, Madhyama, Adhama
  bhumi_tattva          Json
  elemental_balance     Json
  sacred_geography      Json
  karmic_history        Json
  dharmic_suitability   Json
  overall_assessment    String    @db.Text
  
  analyzedAt            DateTime  @default(now())
}

// ==================== CLIMATE ANALYSIS ====================

model ClimateAnalysis {
  id                    String    @id @default(uuid())
  propertyId            String    @unique
  property              Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  overallRiskScore      Int       // 0-100 (higher = more risk)
  riskGrade             String    // LOW, MODERATE, HIGH, EXTREME
  
  // Flood Risk
  currentFloodZone      String?   // FEMA zone
  floodRisk2030         Int
  floodRisk2050         Int
  floodRisk2075         Int
  floodRisk2100         Int
  seaLevelRiseCm        Json      // {2030: 15, 2050: 45, 2100: 122}
  
  // Wildfire Risk
  wildfireRisk          Int
  fireHistoryWithin10Mi Int       // Number of fires in last 20 years
  vegetationDensity     String?
  
  // Hurricane/Tornado
  hurricaneRisk         Int
  tornadoRisk           Int
  historicalStorms      Int
  
  // Heat Risk
  currentExtremeDays    Int       // Days >95°F per year
  projectedExtreme2050  Int
  heatIslandEffect      Float?    // Temperature increase due to urbanization
  
  // Drought
  droughtRisk           Int
  waterStressIndex      Float?
  aquiferDepletionRate  Float?
  
  // Seismic
  seismicRisk           Int
  nearestFaultMi        Float?
  liquefactionPotential String?
  
  // Insurance Projections
  insuranceCurrent      Decimal?  @db.Decimal(10, 2)
  insurance2030         Decimal?  @db.Decimal(10, 2)
  insurance2050         Decimal?  @db.Decimal(10, 2)
  insurabilityStatus    String?   // INSURABLE, AT_RISK, UNINSURABLE
  
  // Mitigation Strategies
  mitigationStrategies  Json[]
  
  // Data Sources
  dataSources           String[]
  analysisDate          DateTime  @default(now())
  
  @@index([overallRiskScore])
}

// ==================== ENVIRONMENTAL DATA (IoT) ====================

model EnvironmentalData {
  id                    String    @id @default(uuid())
  propertyId            String    @unique
  property              Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Air Quality
  aqiCurrent            Int?
  pm25                  Float?
  pm10                  Float?
  co2                   Float?
  vocs                  Float?
  ozone                 Float?
  airQualityGrade       String?
  
  // Water Quality
  tds                   Float?    // Total Dissolved Solids
  ph                    Float?
  leadLevel             Float?
  bacteriaPresent       Boolean?
  waterGrade            String?
  
  // EMF Radiation
  emfLevel              Float?    // μT (microteslas)
  emfGrade              String?
  nearestCellTower      Float?    // Distance in meters
  powerLineProximity    Float?
  
  // Noise
  avgNoiseDecibels      Float?
  peakNoiseDecibels     Float?
  noiseGrade            String?
  noiseSources          String[]
  
  // Radon
  radonLevel            Float?    // pCi/L
  radonRisk             String?
  
  // Mold & Humidity
  avgHumidity           Float?
  moldRisk              String?
  
  // Light Pollution
  lightPollutionIndex   Float?    // Bortle scale
  stargazingQuality     String?
  
  lastUpdated           DateTime  @default(now())
  
  @@index([aqiCurrent])
}

model IoTSensor {
  id              String    @id @default(uuid())
  propertyId      String
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  sensorType      SensorType
  deviceId        String    @unique
  manufacturer    String?
  model           String?
  installDate     DateTime?
  lastReading     DateTime?
  status          String    @default("ACTIVE")
  readings        IoTReading[]
  
  @@index([propertyId, sensorType])
}

enum SensorType {
  AIR_QUALITY
  WATER_QUALITY
  EMF
  NOISE
  RADON
  HUMIDITY
  TEMPERATURE
  SEISMIC
  WEATHER
  SOIL
  WILDLIFE
  TRAFFIC
}

model IoTReading {
  id          String    @id @default(uuid())
  sensorId    String
  sensor      IoTSensor @relation(fields: [sensorId], references: [id], onDelete: Cascade)
  timestamp   DateTime  @default(now())
  value       Float
  unit        String
  metadata    Json?
  
  @@index([sensorId, timestamp])
}

// ==================== ENERGY ANALYSIS ====================

model EnergyAnalysis {
  id                    String    @id @default(uuid())
  propertyId            String    @unique
  property              Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Current Consumption
  annualElectricityKwh  Float?
  annualGasTherms       Float?
  annualWaterGallons    Float?
  carbonFootprintTons   Float?
  
  // Solar Potential
  solarPotentialKwh     Float?
  roofAreaSqft          Float?
  roofOrientation       String?
  shadeAnalysis         Json?
  solarROIYears         Float?
  
  // Efficiency Score
  energyEfficiencyScore Int?      // 0-100
  energyStarRating      String?
  
  // Recommendations
  recommendations       Json[]    // Solar, insulation, HVAC, etc.
  potentialSavings      Decimal?  @db.Decimal(10, 2)
  
  analyzedAt            DateTime  @default(now())
}

// ==================== BLOCKCHAIN ====================

model BlockchainRecord {
  id              String    @id @default(uuid())
  propertyId      String
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  recordType      BlockchainRecordType
  transactionHash String    @unique
  blockNumber     BigInt
  chainId         Int       @default(137) // Polygon
  ipfsHash        String?   // For document storage
  data            Json
  verified        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  
  @@index([propertyId, recordType])
  @@index([transactionHash])
}

enum BlockchainRecordType {
  OWNERSHIP_TRANSFER
  RENOVATION
  INSPECTION
  INSURANCE_CLAIM
  DISPUTE
  LIEN
  APPRAISAL
  MAINTENANCE
  VASTU_CERTIFICATION
  CLIMATE_REPORT
}

model FractionalShare {
  id              String    @id @default(uuid())
  propertyId      String
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  ownerAddress    String    // Wallet address
  sharePercentage Float
  purchasePrice   Decimal   @db.Decimal(15, 2)
  purchaseDate    DateTime
  tokenId         String?   // NFT token ID
  status          String    @default("ACTIVE")
  
  @@unique([propertyId, ownerAddress])
  @@index([ownerAddress])
}

// ==================== ASTROLOGICAL TIMING ====================

model AuspiciousTiming {
  id              String    @id @default(uuid())
  userId          String
  propertyId      String?
  eventType       AstroEventType
  
  // Birth Chart (if provided)
  birthChart      Json?     // Kundali data
  
  // Recommended Windows
  viewingWindows  Json[]    // Array of date-time ranges
  offerWindows    Json[]
  closingWindows  Json[]
  movingWindows   Json[]
  
  // Muhurat Details
  panchang        Json?     // Tithi, Nakshatra, Yoga, Karana
  planetaryPositions Json?
  
  // Warnings
  inauspiciousDates Json[]  // Rahu Kaal, eclipses, etc.
  
  generatedAt     DateTime  @default(now())
  validUntil      DateTime
  
  @@index([userId, eventType])
}

enum AstroEventType {
  PROPERTY_VIEWING
  MAKING_OFFER
  SIGNING_CONTRACT
  CLOSING
  GRIHA_PRAVESH  // Housewarming
  RENOVATION_START
}

// ==================== NEIGHBORHOOD ====================

model Neighborhood {
  id                    String    @id @default(uuid())
  name                  String
  city                  String
  state                 String
  country               String    @default("USA")
  boundaries            Json?     // GeoJSON polygon
  
  // Demographics
  population            Int?
  medianAge             Float?
  medianIncome          Decimal?  @db.Decimal(10, 2)
  demographicsJson      Json?
  
  // Real Estate
  medianHomePrice       Decimal?  @db.Decimal(15, 2)
  priceTrend6Month      Float?
  priceTrend1Year       Float?
  avgDaysOnMarket       Int?
  
  // Scores
  walkabilityScore      Int?      // 0-100
  transitScore          Int?
  bikeScore             Int?
  crimeIndex            Int?      // Lower is safer
  schoolRating          Float?    // 0-10
  
  // Community
  dominantCulture       String?
  communityEvents       Json?
  religiousPlaces       Json?     // Temples, churches, mosques
  
  // Amenities
  nearbyAmenities       Json?
  restaurants           Int?
  parks                 Int?
  gyms                  Int?
  
  // Properties
  properties            Property[]
  
  updatedAt             DateTime  @updatedAt
  
  @@unique([name, city, state])
  @@index([city, state])
}

// ==================== LEADS & COMMUNICATION ====================

model Lead {
  id              String    @id @default(uuid())
  propertyId      String
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  agentId         String?
  agent           Agent?    @relation("AgentLeads", fields: [agentId], references: [id])
  userId          String?
  user            User?     @relation("BuyerLeads", fields: [userId], references: [id])
  
  // Contact Info (for anonymous leads)
  name            String
  email           String
  phone           String?
  message         String?   @db.Text
  
  // Status
  status          LeadStatus @default(NEW)
  priority        LeadPriority @default(MEDIUM)
  score           Int?      // AI-generated lead score 0-100
  
  // Source
  source          LeadSource @default(INQUIRY)
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  
  // Activity
  propertiesViewed Int      @default(0)
  timeOnSite      Int?      // seconds
  lastActivity    DateTime?
  
  // Follow-up
  followUpDate    DateTime?
  notes           String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  messages        Message[]
  showings        Showing[]
  
  @@index([agentId, status])
  @@index([propertyId])
  @@index([email])
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  SHOWING_SCHEDULED
  OFFER_MADE
  NEGOTIATING
  CLOSED_WON
  CLOSED_LOST
  NURTURING
}

enum LeadPriority {
  HOT
  WARM
  MEDIUM
  COLD
}

enum LeadSource {
  INQUIRY
  WALK_IN
  REFERRAL
  ADVERTISING
  SOCIAL_MEDIA
  OPEN_HOUSE
  AI_MATCHED
}

model Message {
  id            String    @id @default(uuid())
  leadId        String?
  lead          Lead?     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  senderId      String
  sender        User      @relation("SentMessages", fields: [senderId], references: [id])
  recipientId   String
  recipient     User      @relation("ReceivedMessages", fields: [recipientId], references: [id])
  content       String    @db.Text
  messageType   MessageType @default(TEXT)
  attachmentUrl String?
  read          Boolean   @default(false)
  readAt        DateTime?
  translated    Boolean   @default(false)
  originalLang  String?
  translatedContent String? @db.Text
  createdAt     DateTime  @default(now())
  
  @@index([leadId])
  @@index([senderId])
  @@index([recipientId])
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
  VOICE
  VIDEO
}

model Showing {
  id            String    @id @default(uuid())
  leadId        String
  lead          Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  scheduledAt   DateTime
  duration      Int       @default(30) // minutes
  type          ShowingType @default(IN_PERSON)
  status        ShowingStatus @default(SCHEDULED)
  notes         String?
  feedback      String?
  rating        Int?      // 1-5 buyer's rating of property
  createdAt     DateTime  @default(now())
  
  @@index([leadId, scheduledAt])
}

enum ShowingType {
  IN_PERSON
  VIRTUAL
  LIVE_VIDEO
  SELF_GUIDED
}

enum ShowingStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ==================== OPEN HOUSES ====================

model OpenHouse {
  id            String    @id @default(uuid())
  propertyId    String
  property      Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  startTime     DateTime
  endTime       DateTime
  type          OpenHouseType @default(IN_PERSON)
  virtualLink   String?
  notes         String?
  maxAttendees  Int?
  registrations OpenHouseRegistration[]
  createdAt     DateTime  @default(now())
  
  @@index([propertyId, startTime])
}

enum OpenHouseType {
  IN_PERSON
  VIRTUAL
  HYBRID
  METAVERSE
}

model OpenHouseRegistration {
  id          String    @id @default(uuid())
  openHouseId String
  openHouse   OpenHouse @relation(fields: [openHouseId], references: [id], onDelete: Cascade)
  name        String
  email       String
  phone       String?
  attended    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  
  @@unique([openHouseId, email])
}

// ==================== SAVED SEARCHES & FAVORITES ====================

model SavedSearch {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String
  filters         Json      // All search criteria
  alertFrequency  AlertFrequency @default(INSTANT)
  isActive        Boolean   @default(true)
  lastAlertAt     DateTime?
  matchCount      Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId, isActive])
}

enum AlertFrequency {
  INSTANT
  DAILY
  WEEKLY
  NEVER
}

model Favorite {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId  String
  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  
  @@unique([userId, propertyId])
  @@index([userId])
}

model PropertyView {
  id          String    @id @default(uuid())
  userId      String?
  user        User?     @relation(fields: [userId], references: [id])
  propertyId  String
  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  sessionId   String?   // For anonymous tracking
  duration    Int?      // seconds
  source      String?
  createdAt   DateTime  @default(now())
  
  @@index([propertyId, createdAt])
  @@index([userId])
}

model PropertyComparison {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId  String
  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  groupId     String    // Groups properties being compared
  createdAt   DateTime  @default(now())
  
  @@unique([userId, propertyId, groupId])
  @@index([userId, groupId])
}

// ==================== REVIEWS ====================

model Review {
  id              String    @id @default(uuid())
  agentId         String
  agent           Agent     @relation("AgentReviews", fields: [agentId], references: [id], onDelete: Cascade)
  reviewerId      String
  reviewer        User      @relation("ReviewAuthor", fields: [reviewerId], references: [id])
  rating          Int       // 1-5
  title           String?
  comment         String    @db.Text
  transactionType TransactionType
  verified        Boolean   @default(false)
  verificationHash String?  // Blockchain verification
  helpful         Int       @default(0)
  response        String?   @db.Text // Agent's response
  responseAt      DateTime?
  createdAt       DateTime  @default(now())
  
  @@index([agentId, rating])
}

enum TransactionType {
  BOUGHT
  SOLD
  RENTED
  LEASED
}

// ==================== INSPECTIONS & DOCUMENTS ====================

model Inspection {
  id              String    @id @default(uuid())
  propertyId      String
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  inspectorName   String
  inspectorLicense String?
  inspectorCompany String?
  inspectionType  InspectionType
  scheduledAt     DateTime
  completedAt     DateTime?
  status          String    @default("SCHEDULED")
  findings        Json?
  overallGrade    String?
  reportUrl       String?
  blockchainHash  String?
  createdAt       DateTime  @default(now())
  
  @@index([propertyId, inspectionType])
}

enum InspectionType {
  GENERAL
  STRUCTURAL
  ELECTRICAL
  PLUMBING
  HVAC
  ROOF
  PEST
  RADON
  MOLD
  LEAD
  ASBESTOS
  POOL
  SEPTIC
  WELL
  VASTU         // Vastu compliance inspection
  ENERGY
}

model PropertyDocument {
  id            String    @id @default(uuid())
  propertyId    String
  property      Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  documentType  DocumentType
  title         String
  description   String?
  fileUrl       String
  fileSize      Int       // bytes
  mimeType      String
  ipfsHash      String?   // For blockchain storage
  uploadedBy    String
  isPublic      Boolean   @default(false)
  expiresAt     DateTime?
  createdAt     DateTime  @default(now())
  
  @@index([propertyId, documentType])
}

enum DocumentType {
  DEED
  TITLE
  SURVEY
  FLOOR_PLAN
  INSPECTION_REPORT
  APPRAISAL
  TAX_RECORD
  HOA_DOCS
  WARRANTY
  PERMIT
  INSURANCE
  DISCLOSURE
  CONTRACT
  VASTU_CERTIFICATE
  CLIMATE_REPORT
  OTHER
}

// ==================== MAINTENANCE ====================

model MaintenanceRecord {
  id              String    @id @default(uuid())
  propertyId      String
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  maintenanceType String
  description     String    @db.Text
  cost            Decimal?  @db.Decimal(10, 2)
  contractor      String?
  contractorPhone String?
  scheduledAt     DateTime?
  completedAt     DateTime?
  nextDueAt       DateTime?
  warrantyExpiry  DateTime?
  receiptUrl      String?
  notes           String?
  blockchainHash  String?
  createdAt       DateTime  @default(now())
  
  @@index([propertyId, maintenanceType])
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          NotificationType
  title         String
  message       String
  data          Json?     // Additional data
  read          Boolean   @default(false)
  readAt        DateTime?
  actionUrl     String?
  createdAt     DateTime  @default(now())
  
  @@index([userId, read])
  @@index([userId, createdAt])
}

enum NotificationType {
  NEW_LISTING
  PRICE_CHANGE
  NEW_LEAD
  MESSAGE
  SHOWING_REMINDER
  OPEN_HOUSE
  OFFER_RECEIVED
  DOCUMENT_READY
  AUSPICIOUS_DATE
  CLIMATE_ALERT
  SENSOR_ALERT
  SYSTEM
}

// ==================== KARMIC SCORING (DHARMIC REPUTATION) ====================

model KarmicScore {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation("UserKarmic", fields: [userId], references: [id], onDelete: Cascade)
  overallScore    Int       // 0-1000 (higher is better)
  
  // Score Components
  honestyScore    Int       // Accurate listings, no hidden defects
  responsivenessScore Int   // Quick replies, keeps appointments
  fairnessScore   Int       // Fair pricing, ethical negotiations
  communityScore  Int       // Helps others, positive reviews
  environmentalScore Int    // Eco-friendly practices
  
  // Activity Tracking
  totalTransactions Int     @default(0)
  disputesInitiated Int     @default(0)
  disputesAgainst Int       @default(0)
  reviewsReceived Int       @default(0)
  avgRating       Float?
  
  // Badges
  badges          String[]  // ["VASTU_CERTIFIED", "ECO_WARRIOR", "TOP_RATED"]
  
  // Penalties
  warnings        Int       @default(0)
  suspensions     Int       @default(0)
  
  lastCalculated  DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([userId])
  @@index([overallScore])
}

// ==================== DAO GOVERNANCE ====================

model DAOProposal {
  id              String    @id @default(uuid())
  title           String
  description     String    @db.Text
  proposerAddress String    // Wallet address
  proposalType    ProposalType
  status          ProposalStatus @default(ACTIVE)
  
  // Voting
  votesFor        Int       @default(0)
  votesAgainst    Int       @default(0)
  votesAbstain    Int       @default(0)
  quorum          Int       // Minimum votes needed
  
  // Timing
  startTime       DateTime  @default(now())
  endTime         DateTime
  executedAt      DateTime?
  
  // Execution
  executionData   Json?     // Data for executing proposal
  transactionHash String?
  
  votes           DAOVote[]
  createdAt       DateTime  @default(now())
  
  @@index([status, endTime])
}

enum ProposalType {
  PLATFORM_FEE_CHANGE
  NEW_FEATURE
  POLICY_CHANGE
  COMMUNITY_FUND
  PARTNERSHIP
  EMERGENCY
}

enum ProposalStatus {
  ACTIVE
  PASSED
  REJECTED
  EXECUTED
  CANCELLED
}

model DAOVote {
  id          String    @id @default(uuid())
  proposalId  String
  proposal    DAOProposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  vote        VoteType
  votePower   Int       @default(1) // Based on token holdings
  txHash      String?
  createdAt   DateTime  @default(now())
  
  @@unique([proposalId, userId])
  @@index([proposalId])
}

enum VoteType {
  FOR
  AGAINST
  ABSTAIN
}

// ==================== TOKEN ECONOMY ====================

model TokenBalance {
  id          String    @id @default(uuid())
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance     Decimal   @default(0) @db.Decimal(18, 8)
  stakedAmount Decimal  @default(0) @db.Decimal(18, 8)
  lockedAmount Decimal  @default(0) @db.Decimal(18, 8)
  totalEarned Decimal   @default(0) @db.Decimal(18, 8)
  lastUpdated DateTime  @default(now())
  
  transactions TokenTransaction[]
}

model TokenTransaction {
  id            String    @id @default(uuid())
  balanceId     String
  balance       TokenBalance @relation(fields: [balanceId], references: [id], onDelete: Cascade)
  type          TokenTransactionType
  amount        Decimal   @db.Decimal(18, 8)
  description   String?
  referenceId   String?   // Related entity ID
  txHash        String?   // Blockchain tx
  createdAt     DateTime  @default(now())
  
  @@index([balanceId, createdAt])
}

enum TokenTransactionType {
  REWARD
  REFERRAL_BONUS
  STAKING_REWARD
  PLATFORM_FEE
  WITHDRAWAL
  PURCHASE
  TRANSFER
}

// ==================== REFERRALS ====================

model Referral {
  id            String    @id @default(uuid())
  referrerId    String
  referrer      User      @relation("Referrer", fields: [referrerId], references: [id])
  referredId    String
  referred      User      @relation("Referred", fields: [referredId], references: [id])
  referralCode  String
  status        ReferralStatus @default(PENDING)
  rewardAmount  Decimal?  @db.Decimal(10, 2)
  rewardPaidAt  DateTime?
  createdAt     DateTime  @default(now())
  
  @@unique([referrerId, referredId])
  @@index([referralCode])
}

enum ReferralStatus {
  PENDING
  QUALIFIED
  REWARDED
  EXPIRED
}

// ==================== VALUATIONS ====================

model PropertyValuation {
  id              String    @id @default(uuid())
  propertyId      String?
  address         String
  latitude        Float?
  longitude       Float?
  
  // Input Data
  bedrooms        Int
  bathrooms       Float
  squareFeet      Int
  yearBuilt       Int?
  propertyType    String
  features        String[]
  
  // Valuation Results
  estimatedValue  Decimal   @db.Decimal(15, 2)
  confidenceLow   Decimal   @db.Decimal(15, 2)
  confidenceHigh  Decimal   @db.Decimal(15, 2)
  confidenceScore Float     // 0-1
  
  // Adjustments
  vastuAdjustment Float?    // % adjustment for Vastu score
  climateAdjustment Float?  // % adjustment for climate risk
  
  // Comparables
  comparables     Json[]
  
  // Model Info
  modelVersion    String
  createdAt       DateTime  @default(now())
  
  @@index([address])
}

// ==================== AI NEGOTIATIONS ====================

model AIANegotiation {
  id              String    @id @default(uuid())
  userId          String
  propertyId      String
  status          NegotiationStatus @default(ANALYZING)
  
  // Analysis
  marketAnalysis  Json?     // Comparable sales, market trends
  sellerAnalysis  Json?     // Motivation indicators
  propertyAnalysis Json?    // Condition, defects
  
  // Strategy
  recommendedOffer Decimal?  @db.Decimal(15, 2)
  maxRecommended  Decimal?  @db.Decimal(15, 2)
  strategy        Json?     // Negotiation tactics
  
  // Offer History
  offers          Json[]    // Array of offer/counter-offer
  currentOffer    Decimal?  @db.Decimal(15, 2)
  
  // Outcome
  finalPrice      Decimal?  @db.Decimal(15, 2)
  savingsAmount   Decimal?  @db.Decimal(15, 2)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId, status])
}

enum NegotiationStatus {
  ANALYZING
  STRATEGY_READY
  OFFER_SENT
  COUNTER_RECEIVED
  NEGOTIATING
  ACCEPTED
  REJECTED
  EXPIRED
}

// ==================== SYSTEM ====================

model AuditLog {
  id          String    @id @default(uuid())
  userId      String?
  action      String
  entityType  String
  entityId    String?
  oldValue    Json?
  newValue    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())
  
  @@index([userId, createdAt])
  @@index([entityType, entityId])
}

model SystemSetting {
  id          String    @id @default(uuid())
  key         String    @unique
  value       Json
  description String?
  updatedAt   DateTime  @updatedAt
}

// ==================== AYURVEDIC PROPERTY ANALYSIS ====================

model AyurvedicAnalysis {
  id                    String    @id @default(uuid())
  analysis_id           String    @unique
  propertyId            String    @unique
  property              Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  vata_score            Int
  pitta_score           Int
  kapha_score           Int
  dominant_dosha        String
  prakriti_description  String
  
  imbalances            Json[]    // Array of {dosha, severity}
  recommendations       String[]
  remedies              Json[]    // Array of {dosha, action, items}
  
  analyzed_at           DateTime  @default(now())
}
